name: Multi-Platform CI/CD

on:
  push:
    branches:
      - "main"
      - "develop"
      - "release/*"
    paths-ignore:
      - "README.md"
      - "LICENSE"
      - "THIRD-PARTY-NOTICES.txt"
      - ".gitignore"
      - ".clang-format"

  pull_request:
    branches:
      - "main"
      - "develop"
      - "release/*"
    paths-ignore:
      - "README.md"
      - "LICENSE"
      - "THIRD-PARTY-NOTICES.txt"
      - ".gitignore"
      - ".clang-format"

  workflow_dispatch:

jobs:
  build-lint-and-test:
    name: ${{ matrix.os }} - ${{ matrix.preset }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux ---
          - name: "Linux GCC 14 Release"
            os: ubuntu-latest
            preset: gcc-release
            compiler_type: gcc
            build-and-test: true
            lint: false

          - name: "Linux Clang 19 Release"
            os: ubuntu-latest
            preset: clang-release-linux
            compiler_type: clang
            build-and-test: true
            lint: false

          - name: "Linux Clang-Tidy"
            os: ubuntu-latest
            preset: tidy-linux
            compiler_type: clang
            build-and-test: false
            lint: true

          # --- Windows ---
          - name: "Windows MSVC Release"
            os: windows-latest
            preset: msvc-release
            compiler_type: msvc
            build-and-test: true
            lint: false

          - name: "Windows MinGW GCC"
            os: windows-latest
            preset: gcc-release
            compiler_type: mingw
            build-and-test: true
            lint: false

          - name: "Windows Clang"
            os: windows-latest
            preset: clang-release-mingw
            compiler_type: mingw
            build-and-test: true
            lint: false

          - name: "Windows Clang-Tidy"
            os: windows-latest
            preset: tidy-mingw
            compiler_type: mingw
            build-and-test: false
            lint: true

    steps:
      - uses: actions/checkout@v4

      # --- Linux Dependencies ---
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build software-properties-common wget

      - name: Install GCC 14
        if: matrix.compiler_type == 'gcc'
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          sudo ln -sf /usr/bin/gcc-14 /usr/bin/gcc
          sudo ln -sf /usr/bin/g++-14 /usr/bin/g++
          echo "CC=gcc-14" >> $GITHUB_ENV
          echo "CXX=g++-14" >> $GITHUB_ENV

      - name: Install Clang 19
        if: matrix.compiler_type == 'clang'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          sudo apt-get install -y clang-tidy-19 libc++-19-dev libc++abi-19-dev
          sudo ln -sf /usr/bin/clang-19 /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-19 /usr/bin/clang++
          sudo ln -sf /usr/bin/clang-tidy-19 /usr/bin/clang-tidy
          echo "CC=clang-19" >> $GITHUB_ENV
          echo "CXX=clang++-19" >> $GITHUB_ENV

      # --- Windows Dependencies ---
      - name: Set up MSVC (Windows)
        if: matrix.compiler_type == 'msvc'
        uses: ilammy/msvc-dev-cmd@v1

      # --- Configure & Build/Lint/Test ---
      - name: Configure CMake
        shell: bash
        run: |
           cmake --preset ${{ matrix.preset }} \
           -DFMTU_ENABLE_JSON=${{ matrix.compiler_type == 'msvc' && 'OFF' || 'ON' }} \
           -DFMTU_ENABLE_YAML=${{ matrix.compiler_type == 'msvc' && 'OFF' || 'ON' }} \
           -DFMTU_ENABLE_TOML=${{ matrix.compiler_type == 'msvc' && 'OFF' || 'ON' }}

      - name: Build
        if: matrix.build-and-test
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Lint
        if: matrix.lint
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Test
        if: matrix.build-and-test
        run: ctest --preset ${{ matrix.preset }} --output-on-failure

  required-check:
    runs-on: ubuntu-latest
    needs: build-lint-and-test
    if: always()
    steps:
      - name: Check Build Status
        run: |
          if [[ "${{ needs.build-lint-and-test.result }}" != "success" ]]; then
            echo "One or more builds failed!"
            exit 1
          fi
          echo "All builds passed successfully."
