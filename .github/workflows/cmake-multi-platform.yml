name: Multi-Platform CI/CD

on:
  push:
    branches:
      - "main"
      - "develop"
      - "release/*"
    tags:
      - "v*.*.*"

  pull_request:
    branches:
      - "main"
      - "develop"
      - "release/*"

  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: read
    outputs:
      should_build: ${{ steps.filter.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            should_build:
              - '**'
              - '!README.md'
              - '!LICENSE'
              - '!THIRD-PARTY-NOTICES.txt'
              - '!.gitignore'
              - '!.clang-format'

  build-lint-and-test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
   
    needs: changes
    if: needs.changes.outputs.should_build == 'true' || github.ref_type == 'tag'

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux ---
          - name: "Linux GCC 14 Release (Build and Test)"
            os: ubuntu-24.04
            preset: gcc-release
            compiler_type: gcc
            build-and-test: true
            lint: false

          - name: "Linux Clang 19 Release (Build and Test)"
            os: ubuntu-24.04
            preset: clang-release-linux
            compiler_type: clang
            build-and-test: true
            lint: false

          - name: "Linux Clang-Tidy (Lint)"
            os: ubuntu-24.04
            preset: lint-linux
            compiler_type: clang
            build-and-test: false
            lint: true

          # --- Windows ---
          - name: "Windows MSVC Release (Build and Test)"
            os: windows-2025
            preset: msvc-release
            compiler_type: msvc
            build-and-test: true
            lint: false

          - name: "Windows MinGW GCC (Build and Test)"
            os: windows-2025
            preset: gcc-release
            compiler_type: mingw
            build-and-test: true
            lint: false

          - name: "Windows Clang (Build and Test)"
            os: windows-2025
            preset: clang-release-mingw
            compiler_type: mingw
            build-and-test: true
            lint: false

          - name: "Windows Clang-Tidy (Lint)"
            os: windows-2025
            preset: lint-mingw
            compiler_type: mingw
            build-and-test: false
            lint: true

    steps:
      - uses: actions/checkout@v4

      # --- Linux Dependencies ---
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build software-properties-common wget

      - name: Install GCC 14
        if: matrix.compiler_type == 'gcc'
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          sudo ln -sf /usr/bin/gcc-14 /usr/bin/gcc
          sudo ln -sf /usr/bin/g++-14 /usr/bin/g++
          echo "CC=gcc-14" >> $GITHUB_ENV
          echo "CXX=g++-14" >> $GITHUB_ENV

      - name: Install Clang 19
        if: matrix.compiler_type == 'clang'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          sudo apt-get install -y clang-tidy-19 libc++-19-dev libc++abi-19-dev
          sudo ln -sf /usr/bin/clang-19 /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-19 /usr/bin/clang++
          sudo ln -sf /usr/bin/clang-tidy-19 /usr/bin/clang-tidy
          echo "CC=clang-19" >> $GITHUB_ENV
          echo "CXX=clang++-19" >> $GITHUB_ENV

      # --- Windows Dependencies ---
      - name: Set up MSVC (Windows)
        if: matrix.compiler_type == 'msvc'
        uses: ilammy/msvc-dev-cmd@v1

      # --- Configure & Build/Lint/Test ---
      - name: Configure CMake
        shell: bash
        run: |
           cmake --preset ${{ matrix.preset }} \
           -DFMTU_ENABLE_JSON=${{ matrix.compiler_type == 'msvc' && 'OFF' || 'ON' }} \
           -DFMTU_ENABLE_YAML=${{ matrix.compiler_type == 'msvc' && 'OFF' || 'ON' }} \
           -DFMTU_ENABLE_TOML=${{ matrix.compiler_type == 'msvc' && 'OFF' || 'ON' }}

      - name: Build
        if: matrix.build-and-test
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Lint
        if: matrix.lint
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Test
        if: matrix.build-and-test
        run: ctest --preset ${{ matrix.preset }} --output-on-failure

  publish-release:
    runs-on: ubuntu-24.04
    needs: build-lint-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ contains(github.ref, 'rc') }}
          generate_release_notes: true
          draft: true
          files: format_utils.hpp
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  required-check:
    runs-on: ubuntu-24.04
    needs: build-lint-and-test
    if: always()
    steps:
      - name: Check Build Status
        run: |
          RESULT="${{ needs.build-lint-and-test.result }}"
          echo "Build Matrix Result: $RESULT"

          if [[ "$RESULT" == "success" || "$RESULT" == "skipped" ]]; then
            echo "Check Passed!"
            exit 0
          else
            echo "Build failed or was cancelled."
            exit 1
          fi
